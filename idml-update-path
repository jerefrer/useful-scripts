#!/usr/bin/env python3

import os
import shutil
import zipfile
import xml.etree.ElementTree as ET
from pathlib import Path
import tempfile

def update_file_paths_in_idml(idml_path, old_path, new_path, backup=True):
    """
    Update file paths in an IDML file.
    
    Args:
        idml_path (str): Path to the IDML file
        old_path (str): Old file path to replace
        new_path (str): New file path to use
        backup (bool): Whether to create a backup of the original file
    
    Returns:
        tuple: (success (bool), message (str), changes_count (int))
    """
    try:
        # Create backup if requested
        if backup:
            backup_path = f"{idml_path}.backup"
            shutil.copy2(idml_path, backup_path)
        
        # Create a temporary directory to extract IDML contents
        with tempfile.TemporaryDirectory() as temp_dir:
            # Extract IDML (which is actually a ZIP file)
            with zipfile.ZipFile(idml_path, 'r') as zip_ref:
                zip_ref.extractall(temp_dir)
            
            changes_count = 0
            
            # Walk through all XML files in the IDML
            for root, _, files in os.walk(temp_dir):
                for file in files:
                    if file.endswith('.xml'):
                        file_path = os.path.join(root, file)
                        
                        # Read the file content
                        with open(file_path, 'r', encoding='utf-8') as f:
                            content = f.read()
                        
                        # Replace the paths in the content
                        new_content = content.replace(old_path, new_path)
                        
                        # If content changed, count it and write back
                        if new_content != content:
                            changes_count += new_content.count(new_path) - content.count(new_path)
                            with open(file_path, 'w', encoding='utf-8') as f:
                                f.write(new_content)
            
            # Create new IDML file
            with zipfile.ZipFile(idml_path, 'w', compression=zipfile.ZIP_DEFLATED) as zip_ref:
                for root, _, files in os.walk(temp_dir):
                    for file in files:
                        file_path = os.path.join(root, file)
                        archive_path = os.path.relpath(file_path, temp_dir)
                        zip_ref.write(file_path, archive_path)
            
            return True, f"Successfully updated {changes_count} file paths", changes_count
            
    except Exception as e:
        return False, f"Error: {str(e)}", 0

def main():
    """Command line interface for the script."""
    import argparse
    
    parser = argparse.ArgumentParser(description='Update file paths in IDML files')
    parser.add_argument('idml_file', help='Path to the IDML file')
    parser.add_argument('old_path', help='Old file path to replace')
    parser.add_argument('new_path', help='New file path to use')
    parser.add_argument('--no-backup', action='store_true', help='Disable backup creation')
    
    args = parser.parse_args()
    
    success, message, count = update_file_paths_in_idml(
        args.idml_file,
        args.old_path,
        args.new_path,
        backup=not args.no_backup
    )
    
    print(message)
    return 0 if success else 1

if __name__ == '__main__':
    main()