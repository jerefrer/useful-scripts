#!/usr/bin/env python3

import sys
import csv
import re
import argparse
from pathlib import Path
import subprocess

def sanitize_filename(filename):
    """Replace problematic characters with ' - ' in filenames"""
    return re.sub(r'[:\\/*?"<>|]', ' - ', filename)

def generate_number(existing, index):
    """Generate or clean up line number"""
    if existing and isinstance(existing, str):
        # Keep existing number if it's valid
        return existing.strip()
    # Generate new number padded to 2 digits
    return f"{index+1:02d}"

def process_csv(input_file, quality="720p"):
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            reader = csv.reader(f, delimiter=';')
            for i, row in enumerate(reader):
                if len(row) < 3:
                    print(f"Skipping malformed line {i+1}: {row}")
                    continue
                
                number = generate_number(row[0], i)
                filename = sanitize_filename(row[1])
                url = row[2].strip()
                
                # Construct yt-dlp command
                cmd = [
                    "yt-dlp",
                    "-f", f"bestvideo[height<={quality[:-1]}]+bestaudio/best[height<={quality[:-1]}]",
                    "-o", f"{number}. {filename}.%(ext)s",
                    url
                ]
                
                print(f"Processing {number}: {filename}")
                subprocess.run(cmd)
                
    except FileNotFoundError:
        sys.exit(f"Error: Input file '{input_file}' not found")
    except csv.Error as e:
        sys.exit(f"Error reading CSV: {e}")
    except Exception as e:
        sys.exit(f"Unexpected error: {e}")

def main():
    parser = argparse.ArgumentParser(description='Process video downloads from CSV file')
    parser.add_argument('input_file', help='Input CSV file (semicolon-separated)')
    parser.add_argument('--quality', default='720p', help='Video quality (default: 720p)')
    
    args = parser.parse_args()
    process_csv(args.input_file, args.quality)

if __name__ == "__main__":
    main()