#!/usr/bin/env python3
import sys
import csv
import re
import argparse
from pathlib import Path
import subprocess

def sanitize_filename(filename):
    """Replace problematic characters with ' - ' in filenames"""
    return re.sub(r'[:\\/*?"<>|]', ' - ', filename)

def clean_quality(quality):
    """Convert quality string to numeric value"""
    quality_value = quality.rstrip('pP')
    if not quality_value.isdigit():
        sys.exit(f"Error: Invalid quality value '{quality}'")
    return quality_value

def process_csv(input_file, quality="720", destination_directory=None):
    if destination_directory:
        Path(destination_directory).mkdir(parents=True, exist_ok=True)
    
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            reader = csv.reader(f, delimiter=';')
            rows = list(reader)
            
            # Determine if we have 2 or 3 columns
            if not rows:
                sys.exit("Error: Empty input file")
                
            col_count = len(rows[0])
            if col_count not in [2, 3]:
                sys.exit(f"Error: Expected 2 or 3 columns, found {col_count}")
            
            for i, row in enumerate(rows):
                if len(row) != col_count:
                    print(f"Skipping malformed line {i+1}: {row}")
                    continue
                
                # If 2 columns: number & url
                # If 3 columns: custom_number, name & url
                if col_count == 2:
                    name, url = row
                    number = f"{i+1:02d}"
                else:
                    number, name, url = row
                    number = number.strip()
                    if not number:  # Handle empty number field
                        number = f"{i+1:02d}"
                
                name = sanitize_filename(name)
                url = url.strip()
                
                output_template = f"{number} - {name}.%(ext)s"
                if destination_directory:
                    output_template = str(Path(destination_directory) / output_template)
                
                cmd = [
                    "yt-dlp",
                    "-f", f"bestvideo[height<={quality}]+bestaudio/best[height<={quality}]",
                    "-o", output_template,
                    url
                ]
                
                print(f"Processing {number}: {name}")
                subprocess.run(cmd)
                
    except FileNotFoundError:
        sys.exit(f"Error: Input file '{input_file}' not found")
    except csv.Error as e:
        sys.exit(f"Error reading CSV: {e}")
    except Exception as e:
        sys.exit(f"Unexpected error: {e}")

def main():
    parser = argparse.ArgumentParser(description='Process video downloads from CSV file')
    parser.add_argument('input_file', help='Input CSV file (semicolon-separated)')
    parser.add_argument('--quality', default='720', help='Video quality (default: 720). Can use "720", "720p", "1080", "1080p" etc.')
    parser.add_argument('--dir', help='Destination directory')
    
    args = parser.parse_args()
    quality = clean_quality(args.quality)
    process_csv(args.input_file, quality, args.dir)

if __name__ == "__main__":
    main()