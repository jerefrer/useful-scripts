#!/usr/bin/env python3
import os
import sys
import subprocess
import time
from pathlib import Path
from datetime import timedelta

def format_time(seconds):
    return str(timedelta(seconds=int(seconds)))

def get_video_duration(file_path):
    cmd = [
        'ffprobe', 
        '-v', 'error',
        '-show_entries', 'format=duration',
        '-of', 'default=noprint_wrappers=1:nokey=1',
        str(file_path)
    ]
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        return float(result.stdout)
    except:
        return None

def convert_to_aac(input_file, total_files, current_file, total_duration, elapsed_duration):
    file_path = Path(input_file)
    parent_dir = file_path.parent
    filename = file_path.stem
    extension = file_path.suffix
    
    output_file = parent_dir / f"{filename}_aac{extension}"
    
    duration = get_video_duration(input_file)
    
    cmd = [
        'ffmpeg',
        '-y',  # Overwrite output files without asking
        '-i', str(input_file),
        '-c:v', 'copy',
        '-c:a', 'aac',
        '-b:a', '192k',
        str(output_file)
    ]
    
    try:
        # Use stderr for progress since ffmpeg writes status there
        process = subprocess.Popen(
            cmd, 
            stderr=subprocess.PIPE,
            universal_newlines=True,
            bufsize=1  # Line buffered
        )
        
        if duration:
            start_time = time.time()
            
            while True:
                line = process.stderr.readline()
                if not line and process.poll() is not None:
                    break
                
                # Look for time progress in ffmpeg output
                if "time=" in line:
                    try:
                        # Extract current timestamp
                        time_str = line.split("time=")[1].split()[0]
                        h, m, s = time_str.split(':')
                        current_duration = float(h) * 3600 + float(m) * 60 + float(s)
                        
                        progress = (current_duration / duration) * 100
                        total_progress = ((elapsed_duration + current_duration) / total_duration) * 100
                        
                        # Calculate ETA
                        elapsed_total = time.time() - start_time
                        if progress > 0:
                            estimated_total = (elapsed_total * 100) / progress
                            remaining_time = estimated_total - elapsed_total
                            
                            sys.stdout.write(f"\rFile {current_file}/{total_files} - {progress:.1f}% | " 
                                           f"Total progress: {total_progress:.1f}% | "
                                           f"ETA: {format_time(remaining_time)}")
                            sys.stdout.flush()
                    except:
                        pass
            
            print()  # New line after progress
            
            if process.returncode == 0:
                print(f"Successfully converted: {input_file}")
                return duration
            else:
                print(f"Error converting {input_file}")
                return 0
                
    except subprocess.CalledProcessError as e:
        print(f"Error converting {input_file}")
        print(f"Error message: {e.stderr}")
        return 0

def is_macos_hidden(file_path):
    return file_path.name.startswith('._') or file_path.name.startswith('.')

def main():
    if len(sys.argv) != 2:
        print("Usage: ./script.py <folder_path>")
        sys.exit(1)
    
    folder_path = Path(sys.argv[1])
    
    if not folder_path.exists() or not folder_path.is_dir():
        print(f"Error: {folder_path} is not a valid directory")
        sys.exit(1)
    
    # Find all video files recursively, including upper and lowercase extensions
    video_files = []
    for extension in ['.mp4', '.MP4', '.mov', '.MOV']:
        video_files.extend([f for f in folder_path.rglob(f"*{extension}") 
                          if not is_macos_hidden(f)])
    
    # Remove duplicates in case of case-insensitive filesystems
    video_files = list(set(video_files))
    
    # Filter out already processed files
    video_files = [f for f in video_files if "_aac" not in f.stem]
    
    # Sort files for consistent processing order
    video_files.sort()

    if not video_files:
        print(f"No video files found in {folder_path}")
        sys.exit(0)
    
    # Calculate total duration of all videos
    print("Analyzing videos...")
    total_duration = 0
    for video_file in video_files:
        duration = get_video_duration(video_file)
        if duration:
            total_duration += duration
    
    # Process each file
    elapsed_duration = 0
    total_files = len(video_files)
    
    print(f"\nTotal files to process: {total_files}")
    print(f"Total duration: {format_time(total_duration)}\n")
    
    for i, video_file in enumerate(video_files, 1):
        print(f"\nStarting file {i}/{total_files}: {video_file}")
        duration = convert_to_aac(video_file, total_files, i, total_duration, elapsed_duration)
        elapsed_duration += duration if duration else 0

if __name__ == "__main__":
    main()