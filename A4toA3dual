#!/usr/bin/env python3

import subprocess
import os
import argparse

def transform_to_a3(input_file, output_file):
    # Get number of pages in the PDF using pdfinfo
    pdfInfo = subprocess.check_output(['pdfinfo', input_file])
    num_pages = int([line for line in pdfInfo.splitlines() if b'Pages' in line][0].split()[-1])

    # Create a temporary directory for intermediate files
    temp_dir = os.path.join(os.path.dirname(output_file), 'temp_pages')
    os.makedirs(temp_dir, exist_ok=True)

    # Step 1: Split the input PDF into individual pages
    subprocess.call(['pdfseparate', input_file, os.path.join(temp_dir, 'page_%d.pdf')])

    # Step 2: Generate the list of pages and their combinations for the new A3 layout
    output_pages = []
    
    # Page 1 goes alone on the first A3 page
    output_pages.append(os.path.join(temp_dir, 'page_1.pdf'))

    # Pair up subsequent pages: 2-3, 4-5, etc.
    for i in range(2, num_pages + 1, 2):
        if i + 1 <= num_pages:
            # Merge two pages into one A3 page (side by side)
            output_page = os.path.join(temp_dir, f'page_{i}_and_{i+1}.pdf')
            subprocess.call([
                'pdfjam',
                os.path.join(temp_dir, f'page_{i}.pdf'),
                os.path.join(temp_dir, f'page_{i+1}.pdf'),
                '--nup', '2x1',
                '--landscape',
                '--paper', 'a3paper',
                '--outfile', output_page
            ])
            output_pages.append(output_page)
        else:
            # If the last page is unpaired, it goes alone
            output_pages.append(os.path.join(temp_dir, f'page_{i}.pdf'))

    # Step 3: Combine all pages into the final output file
    subprocess.call(['pdfunite'] + output_pages + [output_file])

    # Clean up temporary files
    for f in os.listdir(temp_dir):
        os.remove(os.path.join(temp_dir, f))
    os.rmdir(temp_dir)

def main():
    # Set up argument parser
    parser = argparse.ArgumentParser(
        description="Transform an A4 PDF to A3, with the first page alone, and subsequent pages in pairs."
    )
    parser.add_argument('input_file', help="The input PDF file (A4 format)")
    parser.add_argument('output_file', help="The output PDF file (A3 format)")

    # Parse arguments
    args = parser.parse_args()

    # Transform the PDF
    transform_to_a3(args.input_file, args.output_file)

if __name__ == "__main__":
    main()

