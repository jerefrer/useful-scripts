#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
Usage: $0 [-t media-type] [-e extension] <folder>

  -t, --type        media type filter: audio | video | all (default: all)
  -e, --extension   specific file extension (e.g. mp3). Overrides --type.
  -h, --help        show this help message

Calculates total duration of matching media files using ffprobe.
EOF
}

MEDIA_TYPE="all"
EXTENSION=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--type)
      MEDIA_TYPE="${2:-}" || true
      shift 2
      ;;
    -e|--extension)
      EXTENSION="${2:-}" || true
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      break
      ;;
  esac
 done

if [ $# -lt 1 ]; then
  usage
  exit 1
fi

TARGET_DIR="$1"
if [ ! -d "$TARGET_DIR" ]; then
  echo "Error: folder not found: $TARGET_DIR" >&2
  exit 1
fi

if ! command -v ffprobe >/dev/null 2>&1; then
  echo "Error: ffprobe is required" >&2
  exit 1
fi

shopt -s nullglob nocaseglob

AUDIO_EXT=(mp3 ogg oga flac wav aif aiff m4a aac wma opus)
VIDEO_EXT=(mp4 mov m4v avi mpg mpeg mkv webm flv wmv)

select_extensions() {
  local type="$1"
  case "$type" in
    audio)
      printf '%s\n' "${AUDIO_EXT[@]}"
      ;;
    video)
      printf '%s\n' "${VIDEO_EXT[@]}"
      ;;
    all)
      printf '%s\n' "${AUDIO_EXT[@]}" "${VIDEO_EXT[@]}"
      ;;
    *)
      echo "Invalid media type: $type" >&2
      exit 1
      ;;
  esac
}

EXT_LIST=()
if [ -n "$EXTENSION" ]; then
  EXT_LIST=("${EXTENSION#.}")
else
  IFS=$'\n' read -r -d '' -a EXT_LIST < <(select_extensions "$MEDIA_TYPE" && printf '\0')
fi

TOTAL_DURATION=0
FOUND_FILES=0

for ext in "${EXT_LIST[@]}"; do
  while IFS= read -r -d '' file; do
    duration=$(ffprobe -v error -select_streams v:0 -show_entries stream=duration \
      -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)

    if [ -z "$duration" ]; then
      duration=$(ffprobe -v error -select_streams a:0 -show_entries stream=duration \
        -of default=noprint_wrappers=1:nokey=1 "$file" 2>/dev/null)
    fi

    if [ -n "$duration" ]; then
      TOTAL_DURATION=$(awk -v total="$TOTAL_DURATION" -v add="$duration" 'BEGIN { printf "%.6f", total + add }')
      FOUND_FILES=$((FOUND_FILES + 1))
    fi
  done < <(find "$TARGET_DIR" -type f -iname "*.${ext}" -print0)
 done

format_seconds() {
  local seconds=$(printf '%.0f' "$1")
  local hours=$((seconds / 3600))
  local minutes=$(((seconds % 3600) / 60))
  local secs=$((seconds % 60))
  printf '%02d:%02d:%02d' "$hours" "$minutes" "$secs"
}

echo "Files counted: $FOUND_FILES"
echo "Total seconds: $TOTAL_DURATION"
echo "H:M:S: $(format_seconds "$TOTAL_DURATION")"
